<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>popstar admin</title>
  <style>
    :root{ --brand:#8ACE00; --bg:#f5f5f2; --ink:#0b0b0c; --muted:rgba(11,11,12,.72); --r:18px; }
    *{box-sizing:border-box}
    body{ margin:0; font-family:-apple-system,BlinkMacSystemFont,"sf pro text",system-ui; background:var(--bg); color:var(--ink); text-transform:lowercase; }
    .wrap{ max-width:980px; margin:0 auto; padding:18px 16px 80px; }
    .top{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 0; }
    .brand{ font-weight:1000; letter-spacing:-.03em; }
    .meta{ color:var(--muted); font-weight:850; font-size:12px; }
    .pill{ display:inline-flex; align-items:center; justify-content:center; padding:10px 12px; border-radius:999px; border:2px solid #000; background:rgba(255,255,255,.92); font-weight:950; cursor:pointer; }
    .card{ background:rgba(255,255,255,.92); border:2px solid #000; border-radius:var(--r); box-shadow:0 14px 30px rgba(0,0,0,.10); padding:14px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:12px; margin-top:12px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    input{ width:100%; padding:12px 12px; border-radius:14px; border:2px solid #000; background:rgba(255,255,255,.96); font-weight:850; outline:none; }
    input:focus{ box-shadow:0 0 0 4px rgba(138,206,0,.28); }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 12px; border-radius:14px; border:2px solid #000; font-weight:1000; cursor:pointer; background:#000; color:#fff; }
    .btn.ok{ background:var(--brand); color:#000; }
    .btn.bad{ background:rgba(255,0,0,.12); color:#000; }
    .small{ font-size:12px; color:var(--muted); font-weight:900; line-height:1.45; }
    .log{ margin-top:10px; padding:10px 12px; border-radius:14px; border:2px solid rgba(0,0,0,.18); background:rgba(255,255,255,.85); }
    .hidden{ display:none !important; }
    .hr{ height:1px; background:rgba(0,0,0,.12); margin:10px 0; }
    .tag{ display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px; border:2px solid #000; font-weight:950; font-size:12px; background:rgba(255,255,255,.92); }
    .tag.primary{ background:var(--brand); }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">popstar ★ admin</div>
      <div class="row" style="justify-content:flex-end">
        <span class="meta" id="ver">loading…</span>
        <button id="refreshBtn" class="pill" type="button">refresh</button>
        <button id="signOutBtn" class="pill" type="button">sign out</button>
      </div>
    </div>

    <div id="authCard" class="card">
      <div style="font-weight:1000; margin-bottom:6px;">login</div>
      <div class="small">email + password login (no magic link).</div>

      <div class="row" style="margin-top:12px;">
        <div style="flex:1 1 260px; min-width:240px;">
          <div class="meta" style="margin-bottom:6px;">email</div>
          <input id="email" type="email" placeholder="admin email" autocomplete="email"/>
        </div>
        <div style="flex:1 1 220px; min-width:200px;">
          <div class="meta" style="margin-bottom:6px;">password</div>
          <input id="password" type="password" placeholder="password" autocomplete="current-password"/>
        </div>
        <div style="flex:0 0 auto;">
          <button id="loginBtn" class="btn ok" type="button">log in</button>
        </div>
      </div>

      <div class="log">
        <div class="meta">status</div>
        <div id="status" class="small">—</div>
        <div class="meta" style="margin-top:10px;">debug</div>
        <div id="debug" class="small">—</div>
      </div>
    </div>

    <div id="app" class="hidden">
      <div class="card">
        <div class="row">
          <div style="font-weight:1000;">admin</div>
          <div id="adminState" class="meta">checking…</div>
        </div>
        <div class="hr"></div>
        <div class="small">approvals are manual. boosts start when approved. (caps + queue enforced in sql)</div>
      </div>

      <div class="grid">
        <div class="card">
          <div class="row">
            <div style="font-weight:1000;">pending sellers</div>
            <div id="pendingCount" class="meta">0</div>
          </div>
          <div id="pendingSellers" class="grid"></div>
        </div>

        <div class="card">
          <div class="row">
            <div style="font-weight:1000;">pending boosts</div>
            <div id="boostCount" class="meta">0</div>
          </div>
          <div id="pendingBoosts" class="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const BUILD = "admin-password-v2-allowlist-fix-2026-02-26";
    const SUPABASE_URL = "https://otvznctmwutbwulbhfvx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im90dnpuY3Rtd3V0Ynd1bGJoZnZ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwNzc3MzcsImV4cCI6MjA4NzY1MzczN30.txShYO4rqLSMHeLuN_2rzRmvXZK3mnPsaabFtTa8Ph8";
    const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const $ = (id) => document.getElementById(id);
    const statusEl = $("status");
    const debugEl  = $("debug");

    $("ver").textContent = BUILD + " · " + new Date().toLocaleString();

    function setStatus(msg){ statusEl.textContent = msg || ""; }
    function setDebug(msg){ debugEl.textContent = msg || ""; }

    window.addEventListener("error", (e) => {
      setStatus("js error ❌");
      setDebug(String(e.message || e.error || e));
    });

    function escapeHtml(str){
      return String(str ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    async function getUserId() {
      const { data: uData, error: uErr } = await supa.auth.getUser();
      if (uErr) return { userId:null, err: uErr.message };
      return { userId: uData?.user?.id || null, err: null };
    }

    async function checkAdmin() {
      const { userId, err } = await getUserId();
      if (!userId) return { ok:false, msg: err || "not logged in" };

      // IMPORTANT: policy allows only self-read, so we MUST filter by id = auth.uid()
      const { data, error } = await supa
        .from("admin_users")
        .select("id,email")
        .eq("id", userId)
        .maybeSingle();

      if (error) return { ok:false, msg: error.message };
      return { ok: !!data, msg: data ? "" : "not allowlisted" };
    }

    function sellerCard(s){
      const el = document.createElement("div");
      el.className = "card";
      const subs = Array.isArray(s.subcategories) ? s.subcategories : [];
      el.innerHTML = `
        <div class="row">
          <div style="min-width:0;">
            <div style="font-weight:1000;">${escapeHtml(s.shop_name || "(no shop name)")}</div>
            <div class="meta">@${escapeHtml(s.depop_handle || "")} · ${escapeHtml([s.city, s.state].filter(Boolean).join(", "))}</div>
            <div class="small" style="margin-top:8px;">
              <span class="tag primary">${escapeHtml(s.main_category || "")}</span>
              ${subs.map(x => `<span class="tag" style="margin-left:6px;">${escapeHtml(x)}</span>`).join("")}
            </div>
            <div class="small" style="margin-top:8px;">email: ${escapeHtml(s.contact_email || "")}</div>
          </div>
          <div class="row" style="justify-content:flex-end;">
            <button class="btn ok" data-approve-seller="${s.id}" type="button">approve</button>
            <button class="btn.bad btn" data-reject-seller="${s.id}" type="button">reject</button>
          </div>
        </div>
      `;
      return el;
    }

    function boostCard(b){
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        <div class="row">
          <div style="min-width:0;">
            <div style="font-weight:1000;">${escapeHtml(b.placement || b.boost_type || "")} boost · ${escapeHtml(String(b.duration_hours ?? ""))}h</div>
            <div class="meta">${b.placement === "genre" ? "genre: " + escapeHtml(b.genre || "") + " · " : ""}status: ${escapeHtml(b.status || "")}</div>
          </div>
          <div class="row" style="justify-content:flex-end;">
            <button class="btn ok" data-approve-boost="${b.id}" type="button">approve</button>
            <button class="btn.bad btn" data-reject-boost="${b.id}" type="button">reject</button>
          </div>
        </div>
      `;
      return el;
    }

    async function load() {
      $("pendingSellers").innerHTML = "";
      $("pendingBoosts").innerHTML = "";

      const admin = await checkAdmin();
      if (!admin.ok) {
        $("adminState").textContent = "not allowlisted (or rls blocked)";
        setDebug(admin.msg || "");
        return;
      }
      $("adminState").textContent = "authenticated ✅";

      const { data: sellers, error: sErr } = await supa
        .from("sellers")
        .select("*")
        .eq("status", "pending")
        .order("created_at", { ascending: true });

      if (sErr) {
        $("pendingSellers").innerHTML = `<div class="small">error loading sellers: ${escapeHtml(sErr.message)}</div>`;
      } else {
        $("pendingCount").textContent = String(sellers.length);
        sellers.forEach(s => $("pendingSellers").appendChild(sellerCard(s)));
      }

      const { data: boosts, error: bErr } = await supa
        .from("boost_purchases")
        .select("*")
        .in("status", ["pending","queued"])
        .order("created_at", { ascending: true });

      if (bErr) {
        $("pendingBoosts").innerHTML = `<div class="small">error loading boosts: ${escapeHtml(bErr.message)}</div>`;
      } else {
        $("boostCount").textContent = String(boosts.length);
        boosts.forEach(b => $("pendingBoosts").appendChild(boostCard(b)));
      }
    }

    async function approveSeller(id) {
      const { error } = await supa
        .from("sellers")
        .update({ status:"approved", approved_at: new Date().toISOString() })
        .eq("id", id);

      if (error) alert("approve seller failed: " + error.message);
      await load();
    }

    async function rejectSeller(id) {
      const { error } = await supa
        .from("sellers")
        .update({ status:"rejected" })
        .eq("id", id);

      if (error) alert("reject seller failed: " + error.message);
      await load();
    }

    async function approveBoost(id) {
      const { error } = await supa.rpc("approve_boost", { p_boost_id: id });
      if (error) {
        alert("approve failed: " + error.message);
        return;
      }
      await load();
    }

    async function rejectBoost(id) {
      const { error } = await supa
        .from("boost_purchases")
        .update({ status:"rejected" })
        .eq("id", id);

      if (error) alert("reject boost failed: " + error.message);
      await load();
    }

    $("loginBtn").addEventListener("click", async () => {
      try {
        setStatus("signing in…");
        setDebug("");

        const email = ($("email").value || "").trim();
        const password = ($("password").value || "").trim();
        if (!email || !password) {
          setStatus("enter email + password");
          return;
        }

        const { error } = await supa.auth.signInWithPassword({ email, password });
        if (error) {
          setStatus("login error ❌");
          setDebug(error.message);
          return;
        }

        setStatus("logged in ✅");
        location.reload();
      } catch (err) {
        setStatus("exception ❌");
        setDebug(err?.message || String(err));
      }
    });

    $("signOutBtn").addEventListener("click", async () => {
      await supa.auth.signOut();
      location.reload();
    });

    $("refreshBtn").addEventListener("click", async () => load());

    document.addEventListener("click", async (e) => {
      const t = e.target;
      if (!(t instanceof HTMLElement)) return;

      const as = t.getAttribute("data-approve-seller");
      const rs = t.getAttribute("data-reject-seller");
      const ab = t.getAttribute("data-approve-boost");
      const rb = t.getAttribute("data-reject-boost");

      if (as) return approveSeller(as);
      if (rs) return rejectSeller(rs);
      if (ab) return approveBoost(ab);
      if (rb) return rejectBoost(rb);
    });

    async function boot() {
      setStatus("js running ✅");
      const { data: { session } } = await supa.auth.getSession();

      if (session) {
        $("authCard").classList.add("hidden");
        $("app").classList.remove("hidden");
        await load();
      } else {
        $("authCard").classList.remove("hidden");
        $("app").classList.add("hidden");
      }

      supa.auth.onAuthStateChange(async (_event, sess) => {
        if (sess) {
          $("authCard").classList.add("hidden");
          $("app").classList.remove("hidden");
          await load();
        } else {
          $("authCard").classList.remove("hidden");
          $("app").classList.add("hidden");
        }
      });
    }

    boot();
  </script>
</body>
</html>
