<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Popstar Admin</title>

  <!-- Supabase JS (global `supabase`) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; background:#111; color:#fff; padding:40px; }
    .box { max-width:520px; margin:auto; padding:24px; border:1px solid #333; border-radius:12px; background:#1a1a1a; }
    input, button { width:100%; padding:12px; margin-top:12px; border-radius:8px; border:none; font-size:16px; }
    input { background:#222; color:#fff; }
    button { background:#00ff88; color:#000; font-weight:700; cursor:pointer; }
    #status { margin-top:16px; font-size:14px; opacity:0.85; white-space:pre-wrap; }
    code { background:#222; padding:2px 6px; border-radius:6px; }
  </style>
</head>
<body>
  <div class="box">
    <h2 style="margin:0 0 8px 0;">Popstar Admin</h2>
    <div style="opacity:0.75; font-size:13px; line-height:1.35;">
      Console helpers: <code>window.supabase</code> (library), <code>window.supa</code> (client)
    </div>

    <input type="email" id="email" placeholder="Email" autocomplete="email" />
    <input type="password" id="password" placeholder="Password" autocomplete="current-password" />
    <button id="loginBtn">Login</button>

    <div id="status"></div>
  </div>

  <script>
    // ðŸ”‘ REPLACE THESE WITH YOUR REAL VALUES (must be a full https URL + anon key)
    const SUPABASE_URL = "YOUR_SUPABASE_URL";       // e.g. https://xxxx.supabase.co
    const SUPABASE_ANON_KEY = "YOUR_SUPABASE_ANON_KEY";

    const statusEl = document.getElementById("status");
    const loginBtn = document.getElementById("loginBtn");

    function setStatus(msg) { statusEl.textContent = msg; }

    // Expose the library namespace for debugging
    window.supabaseLib = window.supabase;

    // Initialize client safely so the page doesn't silently fail
    (function initSupabaseClient() {
      try {
        if (!window.supabase) {
          setStatus("Supabase library didn't load.\nCheck that the CDN script is reachable (no CSP/network block).");
          window.supa = undefined;
          return;
        }

        const looksPlaceholder =
          (SUPABASE_URL.includes("YOUR_SUPABASE") || SUPABASE_ANON_KEY.includes("YOUR_SUPABASE"));

        if (looksPlaceholder) {
          setStatus(
            "Supabase keys are still placeholders.\n" +
            "Edit admin.html and replace:\n" +
            "  SUPABASE_URL with your https://xxxx.supabase.co\n" +
            "  SUPABASE_ANON_KEY with your anon public key\n\n" +
            "After saving + reloading, run in console:\n" +
            "  window.supa\n" +
            "  await window.supa.auth.getUser()"
          );
          window.supa = undefined;
          return;
        }

        // Create client
        const supa = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // âœ… CRITICAL FIX â€” expose the actual client instance
        window.supa = supa;

        setStatus("Supabase client ready.\nTry in console: await window.supa.auth.getUser()");
      } catch (e) {
        window.supa = undefined;
        setStatus("Supabase init error:\n" + (e && e.message ? e.message : String(e)));
      }
    })();

    loginBtn.addEventListener("click", login);

    async function login() {
      if (!window.supa) {
        setStatus("Supabase client not initialized.\nFix SUPABASE_URL / SUPABASE_ANON_KEY and reload.");
        return;
      }

      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;

      setStatus("Logging in...");

      const { error } = await window.supa.auth.signInWithPassword({ email, password });
      if (error) {
        setStatus("Login failed: " + error.message);
        return;
      }

      setStatus("Logged in. Checking session...");

      // Guard against early session false-negatives
      const { data: { session }, error: sessErr } = await window.supa.auth.getSession();
      if (sessErr) {
        setStatus("Session check error: " + sessErr.message);
        return;
      }

      const user = session?.user;
      if (!user) {
        setStatus("No session found after login.");
        return;
      }

      setStatus("Session OK. Checking allowlist...");

      // Client-side allowlist check (may be blocked by RLS)
      const { data, error: allowErr } = await window.supa
        .from("admin_users")
        .select("id")
        .or(`user_id.eq.${user.id},email.eq.${user.email}`)
        .limit(1);

      if (allowErr) {
        setStatus("not allowlisted (or rls blocked)\n" + allowErr.message);
        return;
      }

      if (!data || data.length === 0) {
        setStatus("not allowlisted");
        return;
      }

      setStatus("âœ… Allowlisted admin verified.");
    }
  </script>
</body>
</html>
